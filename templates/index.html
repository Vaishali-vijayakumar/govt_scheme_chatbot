document.addEventListener('DOMContentLoaded', function() {
    const chatWindow = document.getElementById('chatWindow');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const voiceButton = document.getElementById('voiceButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const schemePreview = document.getElementById('schemePreview');
    const closePreview = document.getElementById('closePreview');
    const schemeTitle = document.getElementById('schemeTitle');
    const schemeDetails = document.getElementById('schemeDetails');
    const applyLink = document.getElementById('applyLink');
    
    let senderId = localStorage.getItem('senderId') || generateUUID();
    localStorage.setItem('senderId', senderId);
    
    // Initialize speech recognition if available
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            userInput.value = transcript;
            sendMessage();
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error', event.error);
            addBotMessage("Sorry, I couldn't understand your voice. Please try typing instead.");
        };
    } else {
        voiceButton.style.display = 'none';
    }
    
    // Event listeners
    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
    });
    
    voiceButton.addEventListener('click', toggleVoiceInput);
    closePreview.addEventListener('click', closeSchemePreview);
    
    // Quick reply buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('quick-reply')) {
            const payload = e.target.getAttribute('data-payload');
            if (payload.startsWith('details_')) {
                const schemeName = payload.replace('details_', '');
                showSchemeDetails(schemeName);
            } else {
                addUserMessage(e.target.textContent);
                simulateTyping(() => {
                    sendToBackend(e.target.textContent, payload);
                });
            }
        }
    });
    
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
    
    function addUserMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'user-message';
        messageDiv.innerHTML = `
            <div class="avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="message-content">
                <p>${message}</p>
            </div>
        `;
        chatWindow.appendChild(messageDiv);
        scrollToBottom();
    }
    
    function addBotMessage(message, quickReplies = [], buttons = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'bot-message';
        
        let quickRepliesHTML = '';
        if (quickReplies.length > 0) {
            quickRepliesHTML = '<div class="quick-replies">' + 
                quickReplies.map(reply => 
                    `<button class="quick-reply" data-payload="${reply.payload || reply.title.toLowerCase()}">${reply.title}</button>`
                ).join('') + 
                '</div>';
        }
        
        messageDiv.innerHTML = `
            <div class="avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <p>${message}</p>
                ${quickRepliesHTML}
            </div>
        `;
        
        chatWindow.appendChild(messageDiv);
        scrollToBottom();
    }
    
    function simulateTyping(callback) {
        typingIndicator.style.display = 'block';
        scrollToBottom();
        
        setTimeout(() => {
            typingIndicator.style.display = 'none';
            callback();
        }, 1500);
    }
    
    function scrollToBottom() {
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    function sendMessage() {
        const message = userInput.value.trim();
        if (message) {
            addUserMessage(message);
            userInput.value = '';
            
            simulateTyping(() => {
                sendToBackend(message);
            });
        }
    }
    
    function toggleVoiceInput() {
        if (recognition) {
            voiceButton.classList.toggle('active');
            if (voiceButton.classList.contains('active')) {
                recognition.start();
                voiceButton.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            } else {
                recognition.stop();
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }
    }
    
    function sendToBackend(message, payload = null) {
        fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                sender: senderId,
                payload: payload
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.text) {
                addBotMessage(data.text, data.quick_replies, data.buttons);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addBotMessage("Sorry, I'm having trouble connecting. Please try again later.");
        });
    }
    
    function showSchemeDetails(schemeName) {
        // In a real app, you might fetch this from your backend
        const schemeData = {
            "PM-KISAN": {
                "category": "Agriculture",
                "steps": "1. Visit https://pmkisan.gov.in\n2. Click 'Farmers Corner' > 'New Farmer Registration'\n3. Submit Aadhaar, bank & land details",
                "eligibility": {"min_age": 18, "occupation": ["farmer"], "income_max": null},
                "benefits": "₹6,000/year in 3 installments",
                "deadline": "Ongoing",
                "link": "https://pmkisan.gov.in"
            },
            "PM-AWAS-YOJANA": {
                "category": "Housing",
                "steps": "1. Contact local municipal office\n2. Submit proof of residence and income\n3. Get approval and subsidy",
                "eligibility": {"min_age": 21, "occupation": null, "income_max": 180000},
                "benefits": "Housing subsidy up to ₹2.67 lakh",
                "deadline": "31-12-2024",
                "link": "https://pmaymis.gov.in"
            }
        }[schemeName];
        
        if (schemeData) {
            schemeTitle.textContent = schemeName;
            schemeDetails.innerHTML = `
                <p><strong>Category:</strong> ${schemeData.category}</p>
                <p><strong>Benefits:</strong> ${schemeData.benefits}</p>
                <p><strong>Deadline:</strong> ${schemeData.deadline}</p>
                <p><strong>Eligibility:</strong></p>
                <ul>
                    ${schemeData.eligibility.min_age ? `<li>Minimum age: ${schemeData.eligibility.min_age}</li>` : ''}
                    ${schemeData.eligibility.income_max ? `<li>Maximum income: ₹${schemeData.eligibility.income_max.toLocaleString()}</li>` : ''}
                    ${schemeData.eligibility.occupation ? `<li>Occupation: ${Array.isArray(schemeData.eligibility.occupation) ? schemeData.eligibility.occupation.join(', ') : schemeData.eligibility.occupation}</li>` : ''}
                </ul>
                <p><strong>Application Steps:</strong></p>
                <p>${schemeData.steps.replace(/\n/g, '<br>')}</p>
            `;
            applyLink.href = schemeData.link;
            schemePreview.classList.add('active');
        }
    }
    
    function closeSchemePreview() {
        schemePreview.classList.remove('active');
    }
    
    // Load any previous messages from session
    function loadPreviousMessages() {
        // In a real app, you might fetch previous messages from your backend
        // using the senderId to maintain conversation history
    }
    
    loadPreviousMessages();
});